<!DOCTYPE html>
<html class="theme theme-black">
<head>
<meta charset="utf-8">
<title>Android 6.0 运行时权限处理</title>
<link href="https://www.zybuluo.com/static/assets/template-theme-black.css" rel="stylesheet" media="screen">
<style type="text/css">

#wmd-preview h1  {
    color: #0077bb; /* 将标题改为蓝色 */
}</style>
</head>
<body class="theme theme-black">
<div id="wmd-preview" class="wmd-preview wmd-preview-full-reader"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="qzkx" id="android-60-运行时权限处理">Android 6.0 运行时权限处理</h1><p data-anchor-id="o7xt"><code class="code-black">android</code></p><hr><div class="md-section-divider"></div><h2 data-anchor-id="u9ln" id="运行时权限介绍">运行时权限介绍</h2><p data-anchor-id="ts2j">Android 6.0在我们原有的AndroidManifest.xml声明权限的基础上， <br>
又新增了运行时权限动态检测，以下权限都需要在运行时判断：</p><pre data-anchor-id="hqya" class="code-black"><code class="code-black"> 1. 身体传感器
 2. 日历
 3. 摄像头
 4. 通讯录
 5. 地理位置
 6. 麦克风
 7. 电话
 8. 短信
 9. 存储空间
</code></pre><div class="md-section-divider"></div><h2 data-anchor-id="v6dh" id="运行时权限处理">运行时权限处理</h2><blockquote data-anchor-id="gjd4" class="black-blockquote">
  <p>Android6.0系统默认为targetSdkVersion小于23的应用默认授予了所申请的所有权限， <br>
  所以如果你以前的APP设置的targetSdkVersion低于23，在运行时也不会崩溃， <br>
  但这也只是一个临时的救急策略，用户还是可以在设置中取消授予的权限。</p>
</blockquote><ul data-anchor-id="b1be">
<li>声明目标SDK版本</li>
</ul><p data-anchor-id="must">我们需要在build.gradle中声明targetSdkVersion为23</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="9jzy"><ol class="linenums"><li class="L0"><code class="language-android"><span class="pln">    android </span><span class="pun">{</span></code></li><li class="L1"><code class="language-android"><span class="pln">     compileSdkVersion </span><span class="lit">23</span></code></li><li class="L2"><code class="language-android"><span class="pln">     buildToolsVersion </span><span class="str">"23.0.1"</span></code></li><li class="L3"><code class="language-android"></code></li><li class="L4"><code class="language-android"><span class="pln">     defaultConfig </span><span class="pun">{</span></code></li><li class="L5"><code class="language-android"><span class="pln">         applicationId </span><span class="str">"com.yourcomany.app"</span></code></li><li class="L6"><code class="language-android"><span class="pln">         minSdkVersion </span><span class="lit">18</span></code></li><li class="L7"><code class="language-android"><span class="pln">         targetSdkVersion </span><span class="lit">23</span></code></li><li class="L8"><code class="language-android"><span class="pln">         versionCode </span><span class="lit">1</span></code></li><li class="L9"><code class="language-android"><span class="pln">         versionName </span><span class="str">"1.0"</span></code></li><li class="L0"><code class="language-android"><span class="pln">     </span><span class="pun">}</span></code></li><li class="L1"><code class="language-android"><span class="pln">     buildTypes </span><span class="pun">{</span></code></li><li class="L2"><code class="language-android"><span class="pln">         release </span><span class="pun">{</span></code></li><li class="L3"><code class="language-android"><span class="pln">             minifyEnabled </span><span class="kwd">false</span></code></li><li class="L4"><code class="language-android"><span class="pln">             proguardFiles getDefaultProguardFile</span><span class="pun">(</span><span class="str">'proguard-android.txt'</span><span class="pun">),</span><span class="pln"> </span><span class="str">'proguard-rules.pro'</span></code></li><li class="L5"><code class="language-android"><span class="pln">         </span><span class="pun">}</span></code></li><li class="L6"><code class="language-android"><span class="pln">     </span><span class="pun">}</span></code></li><li class="L7"><code class="language-android"><span class="pln">    </span><span class="pun">}</span></code></li></ol></pre><ul data-anchor-id="6j3y">
<li>检查并申请权限</li>
</ul><p data-anchor-id="cngf">我们需要在用到权限的地方，每次都检查是否APP已经拥有权限， <br>
比如我们有一个下载功能，需要写SD卡的权限， <br>
我们在写入之前检查是否有WRITE_EXTERNAL_STORAGE权限，没有则申请权限</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="m0b9"><ol class="linenums"><li class="L0"><code class="language-android"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">ContextCompat</span><span class="pun">.</span><span class="pln">checkSelfPermission</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Manifest</span><span class="pun">.</span><span class="pln">permission</span><span class="pun">.</span><span class="pln">WRITE_EXTERNAL_STORAGE</span><span class="pun">)</span></code></li><li class="L1"><code class="language-android"><span class="pln">              </span><span class="pun">!=</span><span class="pln"> </span><span class="typ">PackageManager</span><span class="pun">.</span><span class="pln">PERMISSION_GRANTED</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code class="language-android"><span class="pln">          </span><span class="com">//申请WRITE_EXTERNAL_STORAGE权限</span></code></li><li class="L3"><code class="language-android"><span class="pln">          </span><span class="typ">ActivityCompat</span><span class="pun">.</span><span class="pln">requestPermissions</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">String</span><span class="pun">[]{</span><span class="typ">Manifest</span><span class="pun">.</span><span class="pln">permission</span><span class="pun">.</span><span class="pln">WRITE_EXTERNAL_STORAGE</span><span class="pun">},</span></code></li><li class="L4"><code class="language-android"><span class="pln">                  WRITE_EXTERNAL_STORAGE_REQUEST_CODE</span><span class="pun">);</span></code></li><li class="L5"><code class="language-android"><span class="pln">      </span><span class="pun">}</span></code></li></ol></pre><ul data-anchor-id="1en4">
<li><p>请求权限后，系统会弹出请求权限的Dialog <br>
<img src="http://static.zybuluo.com/smallcao/yxopw2271fhp4bh4iitzn8ib/image_1avg26bs49s8mv3163914mj1skn9.png" alt="image_1avg26bs49s8mv3163914mj1skn9.png-38kB"></p></li>
<li><p>用户选择允许或拒绝后，会回调onRequestPermissionsResult方法, 该方法类似于onActivityResult</p></li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="hm5n"><ol class="linenums"><li class="L0"><code class="language-android"><span class="lit">@Override</span></code></li><li class="L1"><code class="language-android"><span class="pln">  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onRequestPermissionsResult</span><span class="pun">(</span><span class="kwd">int</span><span class="pln"> requestCode</span><span class="pun">,</span><span class="pln"> </span><span class="typ">String</span><span class="pun">[]</span><span class="pln"> permissions</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pun">[]</span><span class="pln"> grantResults</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code class="language-android"><span class="pln">      </span><span class="kwd">super</span><span class="pun">.</span><span class="pln">onRequestPermissionsResult</span><span class="pun">(</span><span class="pln">requestCode</span><span class="pun">,</span><span class="pln"> permissions</span><span class="pun">,</span><span class="pln"> grantResults</span><span class="pun">);</span></code></li><li class="L3"><code class="language-android"><span class="pln">      doNext</span><span class="pun">(</span><span class="pln">requestCode</span><span class="pun">,</span><span class="pln">grantResults</span><span class="pun">);</span></code></li><li class="L4"><code class="language-android"><span class="pln">  </span><span class="pun">}</span></code></li></ol></pre><ul data-anchor-id="abo8">
<li>我们接着需要根据requestCode和grantResults(授权结果)做相应的后续处理</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="8gnu"><ol class="linenums"><li class="L0"><code class="language-android"><span class="kwd">private</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> doNext</span><span class="pun">(</span><span class="kwd">int</span><span class="pln"> requestCode</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pun">[]</span><span class="pln"> grantResults</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code class="language-android"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">requestCode </span><span class="pun">==</span><span class="pln"> WRITE_EXTERNAL_STORAGE_REQUEST_CODE</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code class="language-android"><span class="pln">          </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">grantResults</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="typ">PackageManager</span><span class="pun">.</span><span class="pln">PERMISSION_GRANTED</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code class="language-android"><span class="pln">              </span><span class="com">// Permission Granted</span></code></li><li class="L4"><code class="language-android"><span class="pln">          </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code class="language-android"><span class="pln">              </span><span class="com">// Permission Denied</span></code></li><li class="L6"><code class="language-android"><span class="pln">          </span><span class="pun">}</span></code></li><li class="L7"><code class="language-android"><span class="pln">      </span><span class="pun">}</span></code></li><li class="L8"><code class="language-android"><span class="pln">  </span><span class="pun">}</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="7gn9" id="fragment中运行时权限的特殊处理">Fragment中运行时权限的特殊处理</h2><ul data-anchor-id="ccgw">
<li>在Fragment中申请权限，不要使用ActivityCompat.requestPermissions, <br>
直接使用Fragment的requestPermissions方法，否则会回调到Activity的onRequestPermissionsResult</li>
<li>如果在Fragment中嵌套Fragment，在子Fragment中使用requestPermissions方法，onRequestPermissionsResult不会回调回来，建议使用getParentFragment().requestPermissions方法， <br>
这个方法会回调到父Fragment中的onRequestPermissionsResult，加入以下代码可以把回调透传到子Fragment</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="c2k1"><ol class="linenums"><li class="L0"><code class="language-android"><span class="lit">@Override</span></code></li><li class="L1"><code class="language-android"><span class="pln">  </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onRequestPermissionsResult</span><span class="pun">(</span><span class="kwd">int</span><span class="pln"> requestCode</span><span class="pun">,</span><span class="pln"> </span><span class="typ">String</span><span class="pun">[]</span><span class="pln"> permissions</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pun">[]</span><span class="pln"> grantResults</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code class="language-android"><span class="pln">      </span><span class="kwd">super</span><span class="pun">.</span><span class="pln">onRequestPermissionsResult</span><span class="pun">(</span><span class="pln">requestCode</span><span class="pun">,</span><span class="pln"> permissions</span><span class="pun">,</span><span class="pln"> grantResults</span><span class="pun">);</span></code></li><li class="L3"><code class="language-android"><span class="pln">      </span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Fragment</span><span class="pun">&gt;</span><span class="pln"> fragments </span><span class="pun">=</span><span class="pln"> getChildFragmentManager</span><span class="pun">().</span><span class="pln">getFragments</span><span class="pun">();</span></code></li><li class="L4"><code class="language-android"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">fragments </span><span class="pun">!=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code class="language-android"><span class="pln">          </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Fragment</span><span class="pln"> fragment </span><span class="pun">:</span><span class="pln"> fragments</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L6"><code class="language-android"><span class="pln">              </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">fragment </span><span class="pun">!=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L7"><code class="language-android"><span class="pln">                  fragment</span><span class="pun">.</span><span class="pln">onRequestPermissionsResult</span><span class="pun">(</span><span class="pln">requestCode</span><span class="pun">,</span><span class="pln">permissions</span><span class="pun">,</span><span class="pln">grantResults</span><span class="pun">);</span></code></li><li class="L8"><code class="language-android"><span class="pln">              </span><span class="pun">}</span></code></li><li class="L9"><code class="language-android"><span class="pln">          </span><span class="pun">}</span></code></li><li class="L0"><code class="language-android"><span class="pln">      </span><span class="pun">}</span></code></li><li class="L1"><code class="language-android"><span class="pln">  </span><span class="pun">}</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="vzco" id="相关开源项目">相关开源项目</h3><p data-anchor-id="r2o0"><a href="https://github.com/hotchemi/PermissionsDispatcher" target="_blank">PermissionsDispatcher</a> <br>
使用标注的方式，动态生成类处理运行时权限，目前还不支持嵌套Fragment。</p><p data-anchor-id="yo82"><a href="https://github.com/tbruyelle/RxPermissions" target="_blank">RxPermissions</a> <br>
基于RxJava的运行时权限检测框架</p><p data-anchor-id="irvs"><a href="https://github.com/anthonycr/Grant" target="_blank">Grant</a> <br>
简化运行时权限的处理，比较灵活</p><p data-anchor-id="f81g"><a href="https://github.com/googlesamples/android-RuntimePermissions" target="_blank">android-RuntimePermissions</a> <br>
Google官方的例子</p><p data-anchor-id="mfec">文／阳春面（简书作者） <br>
原文链接：<a href="http://www.jianshu.com/p/b4a8b3d4f587" target="_blank">http://www.jianshu.com/p/b4a8b3d4f587</a> <br>
著作权归作者所有，转载请联系作者获得授权，并标注“简书作者”。</p></div>
</body>
</html>